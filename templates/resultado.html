<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8">
  <title>Resultado da validação</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body {
      background: #f5f7fb;
    }

    .page-header {
      margin-bottom: 1rem;
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #6c757d;
      margin-bottom: 0.4rem;
      font-weight: 600;
    }

    .card {
      border-radius: 0.75rem;
      border: 1px solid #e2e6f0;
    }

    .card-header {
      background-color: #f9fafc;
      border-bottom-color: #e2e6f0;
      padding: 0.6rem 0.9rem;
    }

    .card-body {
      padding: 0.8rem 0.9rem;
    }

    .card+.card {
      margin-top: 0.6rem;
    }

    .card-body-scroll {
      max-height: 400px;
      overflow-y: auto;
    }

    /* Torna o cabeçalho da tabela fixo dentro do card */
    .table-fixed-header {
      max-height: 420px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
    }

    /* Cabeçalho fixo */
    .table-fixed-header thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background-color: #f8f9fa !important;
      border-bottom: 2px solid #dee2e6;
    }

    /* Divisórias verticais entre as colunas */
    .table-fixed-header td,
    .table-fixed-header th {
      border-right: 1px solid #e2e2e2;
    }

    .table-fixed-header td:last-child,
    .table-fixed-header th:last-child {
      border-right: none;
    }

    /* Melhora a leitura das linhas */
    .table-striped>tbody>tr:nth-of-type(odd)>* {
      background-color: #fafafa;
    }

    /* Ajuste de fonte e padding */
    .table-fixed-header td,
    .table-fixed-header th {
      font-size: 0.85rem;
      padding: 6px 8px;
    }

    .cursor-pointer {
      cursor: pointer;
    }

    .titulo-detalhes {
      font-size: 0.8rem;
    }

    .summary-card {
      background: #fff;
      border: 1px solid #e4e7f2;
      border-radius: 0.9rem;
      padding: 1rem 1.2rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
      height: 100%;
    }

    .summary-card .icon-shape {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
    }

    .summary-card .label {
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #7b8197;
      margin-bottom: 0.2rem;
      font-weight: 600;
    }

    .summary-card .value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #1f2937;
      line-height: 1.1;
    }

    .summary-card small {
      color: #6c7385;
    }

    /* Stack helpers para alinhar cards verticalmente */
    .card-stack {
      display: grid;
      gap: 0.75rem;
      align-content: start;
    }

    /* Destaque para o card de títulos */
    .titles-card {
      background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%);
      border: 1px solid #dfe6ff;
      box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
      border-radius: 12px;
    }

    .titles-card .card-header {
      background: transparent;
      border-bottom: 1px solid #e6ebff;
      color: #0f1f4b;
    }

    .titles-card .card-body {
      background: #fff;
      min-height: 260px;
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="/">
        <i class="bi bi-file-earmark-text me-2"></i>
        Validador CNAB
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link active" href="/">
              <i class="bi bi-hdd-network me-1"></i>
              Validar Remessa
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/boleto">
              <i class="bi bi-upc-scan me-1"></i>
              Linha Digitável
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  {% set total_erros =
  (resultado.erros_tamanho|length) +
  (resultado.erros_estrutura|length) +
  (resultado.erros_banco|length) +
  (resultado.erros_lotes|length) +
  (resultado.erros_sequencia|length) +
  (resultado.erros_segmentos|length) +
  (resultado.erros_dados_conta|length) +
  (resultado.cnab400_erros_header|length if resultado.cnab400_erros_header is defined else 0) +
  (resultado.cnab400_erros_registros|length if resultado.cnab400_erros_registros is defined else 0) +
  (resultado.cnab400_erros_trailer|length if resultado.cnab400_erros_trailer is defined else 0) +
  (resultado.itau_sisdeb_erros_header|length if resultado.itau_sisdeb_erros_header is defined else 0) +
  (resultado.itau_sisdeb_erros_lotes|length if resultado.itau_sisdeb_erros_lotes is defined else 0) +
  (resultado.itau_sisdeb_erros_detalhes|length if resultado.itau_sisdeb_erros_detalhes is defined else 0) +
  (resultado.itau_sisdeb_erros_trailer|length if resultado.itau_sisdeb_erros_trailer is defined else 0)
  %}
  {% set total_avisos =
  (resultado.avisos_segmentos|length) +
  (resultado.avisos_dados_conta|length) +
  (resultado.cnab400_avisos|length if resultado.cnab400_avisos is defined else 0) +
  (resultado.itau_sisdeb_avisos|length if resultado.itau_sisdeb_avisos is defined else 0)
  %}
  {% set total_titulos =
  resultado.titulos|length if resultado.titulos
  else (resultado.resumo_remessa.qtd_titulos if resultado.resumo_remessa else 0)
  %}

  <main class="container mb-5">
    <div class="row">
      <div class="col-12 col-lg-10 mx-auto">

        <!-- Cabeçalho página -->
        <div class="page-header d-flex justify-content-between align-items-center">
          <div>
            <h1 class="h4 mb-1">Resultado da validação da remessa</h1>
            <small class="text-muted">Visão geral e detalhes da estrutura do arquivo.</small>
          </div>
          <a href="/" class="btn btn-outline-secondary btn-sm">
            &larr; Validar outro arquivo
          </a>
        </div>

        <!-- Resumo geral -->
        <div class="mb-3">
          {% if total_erros > 0 %}
          <div class="alert alert-danger d-flex align-items-center mb-0" role="alert">
            <i class="bi bi-x-circle-fill me-2"></i>
            <div>
              Foram encontrados <strong>{{ total_erros }}</strong> erro(s)
              {% if total_avisos > 0 %}
              e <strong>{{ total_avisos }}</strong> aviso(s).
              {% endif %}
            </div>
          </div>
          {% elif total_avisos > 0 %}
          <div class="alert alert-warning d-flex align-items-center mb-0" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <div>
              Nenhum erro crítico encontrado, mas existem <strong>{{ total_avisos }}</strong> aviso(s).
            </div>
          </div>
          {% else %}
          <div class="alert alert-success d-flex align-items-center mb-0" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <div>
              Arquivo validado com sucesso. Nenhum erro ou aviso foi encontrado nas regras aplicadas.
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Resumo rápido -->
        <div class="summary-grid row row-cols-1 row-cols-sm-2 row-cols-xl-4 g-3 mb-4">
          <div class="col">
            <div class="summary-card">
              <div class="icon-shape bg-primary bg-opacity-10 text-primary">
                <i class="bi bi-diagram-3"></i>
              </div>
              <div>
                <div class="label">Layout</div>
                <div class="value">
                  {% if resultado.layout == 240 %}
                  CNAB 240
                  {% elif resultado.layout == 400 %}
                  CNAB 400
                  {% else %}
                  {{ resultado.layout or "Indefinido" }}
                  {% endif %}
                </div>
                <small>Formato detectado automaticamente</small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="summary-card">
              <div class="icon-shape bg-success bg-opacity-10 text-success">
                <i class="bi bi-bank"></i>
              </div>
              <div>
                <div class="label">Banco</div>
                <div class="value">
                  {% if resultado.codigo_banco %}
                  {{ resultado.codigo_banco }}
                  {% else %}
                  N/D
                  {% endif %}
                </div>
                <small>{{ resultado.nome_banco or "Banco não identificado" }}</small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="summary-card">
              <div class="icon-shape bg-info bg-opacity-10 text-info">
                <i class="bi bi-collection"></i>
              </div>
              <div>
                <div class="label">Títulos encontrados</div>
                <div class="value">
                  {{ total_titulos }}
                </div>
                <small>
                  {% if resultado.layout == 400 %}
                  Resumo CNAB 400
                  {% else %}
                  Segmentos P/Q processados
                  {% endif %}
                </small>
              </div>
            </div>
          </div>
          <div class="col">
            <div class="summary-card">
              <div class="icon-shape bg-warning bg-opacity-10 text-warning">
                <i class="bi bi-clipboard-check"></i>
              </div>
              <div>
                <div class="label">Status</div>
                <div class="value">
                  {{ total_erros }}
                </div>
                <small>
                  {{ "erro(s)" if total_erros != 1 else "erro" }}
                  {% if total_avisos %}
                  • {{ total_avisos }} aviso(s)
                  {% endif %}
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- GRID PRINCIPAL: duas colunas em telas médias/grandes -->
        <div class="row row-cols-1 row-cols-lg-2 g-3 align-items-start">
          <!-- Coluna esquerda: informações e conferência -->
          <div class="col-12 col-lg-6 card-stack">
            <div class="section-title">Arquivo e cedente</div>

            <!-- Informações gerais -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Informações gerais</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseInfoGerais" aria-expanded="true" aria-controls="collapseInfoGerais">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseInfoGerais" class="collapse show">
                <div class="card-body">
                  <p class="mb-1">
                    Layout detectado:
                    {% if resultado.layout == 240 %}
                    <span class="badge bg-success">CNAB 240</span>
                    {% elif resultado.layout == 400 %}
                    <span class="badge bg-success">CNAB 400</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ resultado.layout }}</span>
                    {% endif %}
                  </p>
                  {% if resultado.codigo_banco %}
                  <p class="mb-0">
                    Banco detectado:
                    <strong>{{ resultado.codigo_banco }} - {{ resultado.nome_banco }}</strong>
                  </p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Dados da conta / titular informados (apenas se houver dados) -->
            {% set dados_fornecidos = (
            (dados_conta.banco if dados_conta else None) or
            (dados_conta.agencia if dados_conta else None) or
            (dados_conta.conta if dados_conta else None) or
            (dados_conta.documento if dados_conta else None) or
            (dados_conta.nome if dados_conta else None)
            ) %}
            {% if dados_fornecidos %}
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Dados da conta / titular informados</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseDadosConta" aria-expanded="true" aria-controls="collapseDadosConta">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseDadosConta" class="collapse show">
                <div class="card-body">
                  <ul class="list-unstyled mb-2 small">
                    {% if dados_conta.banco %}
                    <li><strong>Banco informado:</strong> {{ dados_conta.banco }}</li>
                    {% endif %}
                    {% if dados_conta.agencia %}
                    <li><strong>Agência:</strong> {{ dados_conta.agencia }}</li>
                    {% endif %}
                    {% if dados_conta.conta %}
                    <li><strong>Conta:</strong> {{ dados_conta.conta }}</li>
                    {% endif %}
                    {% if dados_conta.documento %}
                    <li><strong>Documento (CPF/CNPJ):</strong> {{ dados_conta.documento }}</li>
                    {% endif %}
                    {% if dados_conta.nome %}
                    <li><strong>Nome/Razão social:</strong> {{ dados_conta.nome }}</li>
                    {% endif %}
                  </ul>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Conferência dos dados x arquivo -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Conferência dos dados da conta/titular</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseConferenciaConta" aria-expanded="true"
                  aria-controls="collapseConferenciaConta">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseConferenciaConta" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_dados_conta and resultado.erros_dados_conta|length > 0 %}
                  <div class="alert alert-danger mb-2">
                    <strong>Divergências encontradas:</strong>
                    <ul class="mb-0">
                      {% for e in resultado.erros_dados_conta %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-2">
                    Nenhuma divergência crítica encontrada entre os dados informados e o arquivo (para os campos
                    suportados).
                  </div>
                  {% endif %}

                  {% if resultado.avisos_dados_conta and resultado.avisos_dados_conta|length > 0 %}
                  <div class="alert alert-warning mb-0">
                    <strong>Avisos:</strong>
                    <ul class="mb-0">
                      {% for a in resultado.avisos_dados_conta %}
                      <li>{{ a }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Tamanho das linhas -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Tamanho das linhas</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseTamanhoLinhas" aria-expanded="true" aria-controls="collapseTamanhoLinhas">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseTamanhoLinhas" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_tamanho and resultado.erros_tamanho|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <p class="mb-1">Problemas encontrados:</p>
                    <ul class="mb-0">
                      {% for e in resultado.erros_tamanho %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Todas as linhas estão com o tamanho correto.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

      <!-- Coluna direita: estrutura CNAB -->
      <div class="col-12 col-lg-6 card-stack">
        <div class="section-title">Estrutura do arquivo</div>
        {% if resultado.layout == 240 %}

            <!-- Estrutura básica -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Estrutura básica</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseEstruturaBasica" aria-expanded="true"
                  aria-controls="collapseEstruturaBasica">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseEstruturaBasica" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_estrutura and resultado.erros_estrutura|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <p class="mb-1">Problemas encontrados:</p>
                    <ul class="mb-0">
                      {% for e in resultado.erros_estrutura %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Header, trailer e tipos de registro estão consistentes.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Código do banco -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Código do banco</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseCodBanco" aria-expanded="true" aria-controls="collapseCodBanco">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseCodBanco" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_banco and resultado.erros_banco|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <p class="mb-1">Inconsistências encontradas:</p>
                    <ul class="mb-0">
                      {% for e in resultado.erros_banco %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Todas as linhas possuem o mesmo código de banco do header.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Lotes -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Estrutura de lotes</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseLotes" aria-expanded="true" aria-controls="collapseLotes">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseLotes" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_lotes and resultado.erros_lotes|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <p class="mb-1">Problemas em lotes:</p>
                    <ul class="mb-0">
                      {% for e in resultado.erros_lotes %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Estrutura de lotes está OK (header, detalhes e trailer).
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Sequência -->
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Sequência dos registros</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseSequencia" aria-expanded="true" aria-controls="collapseSequencia">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseSequencia" class="collapse show">
                <div class="card-body">
                  {% if resultado.erros_sequencia and resultado.erros_sequencia|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <p class="mb-1">Problemas na sequência:</p>
                    <ul class="mb-0">
                      {% for e in resultado.erros_sequencia %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Sequência dos registros dentro dos lotes está correta.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Seção resumo + títulos + segmentos: em largura total -->
        <div class="mt-4">
          <div class="section-title">Detalhamento da remessa</div>

          <!-- Resumo da remessa -->
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Resumo da remessa (títulos detectados)</strong>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseResumoRemessa" aria-expanded="true" aria-controls="collapseResumoRemessa">
                <span class="label-btn">Recolher</span>
                <i class="bi bi-chevron-up"></i>
              </button>
            </div>
            <div id="collapseResumoRemessa" class="collapse show">
              <div class="card-body">
                {% if resultado.resumo_remessa %}
                {% set r = resultado.resumo_remessa %}
                {% if r.qtd_titulos > 0 %}
                <ul class="mb-0">
                  <li>
                    {% if resultado.cnab240_itau_sisdeb %}
                    Quantidade de lançamentos (Segmento A - SISDEB):
                    {% else %}
                    Quantidade de títulos (Segmento P):
                    {% endif %}
                    <strong>{{ r.qtd_titulos }}</strong>
                  </li>
                  <li>Valor total:
                    <strong>R$ {{ "%.2f"|format(r.valor_total_reais) }}</strong>
                  </li>
                  <li>Vencimento mais antigo:
                    {% if r.vencimento_min %}
                    {{ r.vencimento_min.strftime("%d/%m/%Y") }}
                    {% else %}
                    (não foi possível determinar)
                    {% endif %}
                  </li>
                  <li>Vencimento mais recente:
                    {% if r.vencimento_max %}
                    {{ r.vencimento_max.strftime("%d/%m/%Y") }}
                    {% else %}
                    (não foi possível determinar)
                    {% endif %}
                  </li>
                </ul>
                {% else %}
                <p class="text-muted mb-0">
                  {% if resultado.cnab240_itau_sisdeb %}
                  Nenhum lançamento SISDEB foi identificado para gerar o resumo.
                  {% else %}
                  Nenhum Segmento P foi encontrado para gerar o resumo da remessa.
                  {% endif %}
                </p>
                {% endif %}
                {% else %}
                <p class="text-muted mb-0">
                  Resumo da remessa não disponível para este layout/banco.
                </p>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Lista de títulos -->
          <div class="card mb-3 border-0 titles-card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-list-check fs-5"></i>
                <div>
                  <strong>Títulos da remessa</strong>
                  {% if resultado.titulos and resultado.titulos|length > 0 %}
                  <span class="badge bg-light text-primary ms-2">
                    {{ resultado.titulos|length }} título(s)
                  </span>
                  {% endif %}
                </div>
              </div>
              <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseTitulos" aria-expanded="true" aria-controls="collapseTitulos">
                <span class="label-btn">Recolher</span>
                <i class="bi bi-chevron-up"></i>
              </button>
            </div>
            <div id="collapseTitulos" class="collapse show">
              <div class="card-body card-body-scroll">
                {% if resultado.titulos and resultado.titulos|length > 0 %}
                <div class="table-responsive">
                  <div class="table-fixed-header">
                    <table id="tabela-titulos" class="table table-sm table-striped align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">#</th>
                          <th scope="col">Lote</th>
                          <th scope="col">Seq.</th>
                          <th scope="col">Nosso número</th>
                          <th scope="col">Documento pagador</th>
                          <th scope="col">Nome do pagador</th>
                          <th scope="col">Endereço</th>
                          <th scope="col">
                            {% if resultado.cnab240_itau_sisdeb %}
                            Data agendada
                            {% else %}
                            Vencimento
                            {% endif %}
                          </th>
                          <th scope="col" class="text-end">Valor (R$)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for t in resultado.titulos %}
                        {% set has_r = t.r_desc2_codigo or t.r_desc3_codigo or t.r_multa_codigo %}

                        <!-- Linha principal -->
                        <tr {% if has_r %} data-bs-toggle="collapse" data-bs-target="#detTitulo{{ loop.index }}"
                          class="cursor-pointer" {% endif %}>
                          <td>{{ loop.index }}</td>
                          <td>{{ t.lote }}</td>
                          <td>{{ t.sequencia }}</td>
                          <td class="fw-semibold">{{ t.nosso_numero }}</td>
                          <td>{{ t.sacado_documento }}</td>
                          <td>{{ t.sacado_nome }}</td>
                          <td>
                            {{ t.sacado_endereco }}
                            {% if t.sacado_bairro %}<br><small>{{ t.sacado_bairro }}</small>{% endif %}
                            {% if t.sacado_cidade %}<br><small>{{ t.sacado_cidade }} - {{ t.sacado_uf }}</small>{% endif
                            %}
                            {% if t.sacado_cep %}<br><small>CEP {{ t.sacado_cep }}</small>{% endif %}
                          </td>
                          <td>
                            {% if t.data_vencimento_str %}
                            {{ t.data_vencimento_str }}
                            {% else %}
                            -
                            {% endif %}
                          </td>
                          <td class="text-end fw-semibold">
                            {{ "%.2f"|format(t.valor_reais) }}
                          </td>
                        </tr>

                        {% if has_r %}
                        <!-- Linha de detalhes (Segmento R) -->
                        <tr id="detTitulo{{ loop.index }}" class="collapse bg-light">
                          <td colspan="9">
                            <div class="titulo-detalhes">
                              <strong>Detalhes adicionais (Segmento R)</strong>
                              <div class="mt-2">

                                {% if t.r_desc2_codigo or t.r_desc2_valor_reais %}
                                <div class="mb-1">
                                  <span class="fw-semibold">Desconto 2:</span>
                                  código {{ t.r_desc2_codigo or "-" }},
                                  {% if t.r_desc2_data_str %} data {{ t.r_desc2_data_str }},{% endif %}
                                  {% if t.r_desc2_valor_reais and t.r_desc2_valor_reais > 0 %}
                                  valor R$ {{ "%.2f"|format(t.r_desc2_valor_reais) }}
                                  {% else %}
                                  valor não informado
                                  {% endif %}
                                </div>
                                {% endif %}

                                {% if t.r_desc3_codigo or t.r_desc3_valor_reais %}
                                <div class="mb-1">
                                  <span class="fw-semibold">Desconto 3:</span>
                                  código {{ t.r_desc3_codigo or "-" }},
                                  {% if t.r_desc3_data_str %} data {{ t.r_desc3_data_str }},{% endif %}
                                  {% if t.r_desc3_valor_reais and t.r_desc3_valor_reais > 0 %}
                                  valor R$ {{ "%.2f"|format(t.r_desc3_valor_reais) }}
                                  {% else %}
                                  valor não informado
                                  {% endif %}
                                </div>
                                {% endif %}

                                {% if t.r_multa_codigo or t.r_multa_valor_reais %}
                                <div class="mb-1">
                                  <span class="fw-semibold">Multa:</span>
                                  código {{ t.r_multa_codigo or "-" }},
                                  {% if t.r_multa_data_str %} data {{ t.r_multa_data_str }},{% endif %}
                                  {% if t.r_multa_valor_reais and t.r_multa_valor_reais > 0 %}
                                  valor/percentual R$ {{ "%.2f"|format(t.r_multa_valor_reais) }}
                                  {% else %}
                                  valor/percentual não informado
                                  {% endif %}
                                </div>
                                {% endif %}

                                {% if not (t.r_desc2_codigo or t.r_desc3_codigo or t.r_multa_codigo) %}
                                <span class="text-muted">Nenhuma informação adicional de Segmento R para este
                                  título.</span>
                                {% endif %}
                              </div>
                            </div>
                          </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {% else %}
                  <p class="text-muted mb-0">
                    {% if resultado.cnab240_itau_sisdeb %}
                    Nenhum lançamento SISDEB foi identificado para listar.
                    {% else %}
                    Nenhum título (Segmento P/Q) foi identificado para listar.
                    {% endif %}
                  </p>
                  {% endif %}
                </div>
              </div>
            </div>
            {% if resultado.cnab240_itau_sisdeb %}
            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Itaú SISDEB - Header de arquivo</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseItauHeader" aria-expanded="true" aria-controls="collapseItauHeader">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseItauHeader" class="collapse show">
                <div class="card-body">
                  {% if resultado.itau_sisdeb_erros_header and resultado.itau_sisdeb_erros_header|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <ul class="mb-0">
                      {% for e in resultado.itau_sisdeb_erros_header %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Nenhum problema identificado no header do arquivo (validações SISDEB).
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Itaú SISDEB - Headers de lote</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseItauLotes" aria-expanded="true" aria-controls="collapseItauLotes">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseItauLotes" class="collapse show">
                <div class="card-body">
                  {% if resultado.itau_sisdeb_erros_lotes and resultado.itau_sisdeb_erros_lotes|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <ul class="mb-0">
                      {% for e in resultado.itau_sisdeb_erros_lotes %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Cabecalhos de lote validados conforme o manual SISDEB.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Itaú SISDEB - Registros de detalhe (Segmento A)</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseItauDetalhes" aria-expanded="true" aria-controls="collapseItauDetalhes">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseItauDetalhes" class="collapse show">
                <div class="card-body">
                  {% if resultado.itau_sisdeb_erros_detalhes and resultado.itau_sisdeb_erros_detalhes|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <ul class="mb-0">
                      {% for e in resultado.itau_sisdeb_erros_detalhes %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Nenhum erro específico nos registros de detalhe SISDEB foi identificado.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Itaú SISDEB - Trailer / totais</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseItauTrailer" aria-expanded="true" aria-controls="collapseItauTrailer">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseItauTrailer" class="collapse show">
                <div class="card-body">
                  {% if resultado.itau_sisdeb_erros_trailer and resultado.itau_sisdeb_erros_trailer|length > 0 %}
                  <div class="alert alert-danger mb-0">
                    <ul class="mb-0">
                      {% for e in resultado.itau_sisdeb_erros_trailer %}
                      <li>{{ e }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                  {% else %}
                  <div class="alert alert-success mb-0">
                    Totais do trailer (lote/arquivo) estão consistentes com os registros.
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            {% if resultado.itau_sisdeb_avisos and resultado.itau_sisdeb_avisos|length > 0 %}
            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <strong>Alertas SISDEB</strong>
                <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                  data-bs-target="#collapseItauAvisos" aria-expanded="true" aria-controls="collapseItauAvisos">
                  <span class="label-btn">Recolher</span>
                  <i class="bi bi-chevron-up"></i>
                </button>
              </div>
              <div id="collapseItauAvisos" class="collapse show">
                <div class="card-body">
                  <div class="alert alert-warning mb-0">
                    <ul class="mb-0">
                      {% for aviso in resultado.itau_sisdeb_avisos %}
                      <li>{{ aviso }}</li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}
            {% endif %}
          </div>

          {% if not resultado.cnab240_itau_sisdeb %}
          <!-- Segmentos -->
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <strong>Validações de segmentos (P, Q, etc.)</strong>
              <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseSegmentos" aria-expanded="true" aria-controls="collapseSegmentos">
                <span class="label-btn">Recolher</span>
                <i class="bi bi-chevron-up"></i>
              </button>
            </div>
            <div id="collapseSegmentos" class="collapse show">
              <div class="card-body card-body-scroll">

                {% set total_avisos_seg =
                (resultado.avisos_segmentos_p|length) +
                (resultado.avisos_segmentos_q|length) +
                (resultado.avisos_segmentos_r|length) +
                (resultado.avisos_segmentos_convenio|length) +
                (resultado.avisos_segmentos_outros|length)
                %}

                {% if total_avisos_seg > 0 %}
                <div class="alert alert-warning mb-2">
                  <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <strong>{{ total_avisos_seg }} aviso(s) em segmentos</strong>
                  </div>

                  {% if resultado.avisos_segmentos_p and resultado.avisos_segmentos_p|length > 0 %}
                  <div class="fw-semibold small mt-2 mb-1">Segmento P</div>
                  <ul class="list-unstyled mb-1">
                    {% for a in resultado.avisos_segmentos_p %}
                    <li class="mb-1 d-flex">
                      <span class="me-2 text-warning">
                        <i class="bi bi-dot"></i>
                      </span>
                      <span class="small">
                        {{ a }}
                      </span>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if resultado.avisos_segmentos_q and resultado.avisos_segmentos_q|length > 0 %}
                  <div class="fw-semibold small mt-2 mb-1">Segmento Q</div>
                  <ul class="list-unstyled mb-1">
                    {% for a in resultado.avisos_segmentos_q %}
                    <li class="mb-1 d-flex">
                      <span class="me-2 text-warning">
                        <i class="bi bi-dot"></i>
                      </span>
                      <span class="small">
                        {{ a }}
                      </span>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if resultado.avisos_segmentos_convenio and resultado.avisos_segmentos_convenio|length > 0 %}
                  <div class="fw-semibold small mt-2 mb-1">Convênio / Carteira / Nosso Número</div>
                  <ul class="list-unstyled mb-1">
                    {% for a in resultado.avisos_segmentos_convenio %}
                    <li class="mb-1 d-flex">
                      <span class="me-2 text-warning">
                        <i class="bi bi-dot"></i>
                      </span>
                      <span class="small">
                        {{ a }}
                      </span>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}

                  {% if resultado.avisos_segmentos_outros and resultado.avisos_segmentos_outros|length > 0 %}
                  <div class="fw-semibold small mt-2 mb-1">Outros avisos de segmentos</div>
                  <ul class="list-unstyled mb-1">
                    {% for a in resultado.avisos_segmentos_outros %}
                    <li class="mb-1 d-flex">
                      <span class="me-2 text-warning">
                        <i class="bi bi-dot"></i>
                      </span>
                      <span class="small">
                        {{ a }}
                      </span>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                </div>
                {% endif %}

                {% if resultado.erros_segmentos and resultado.erros_segmentos|length > 0 %}
                <div class="alert alert-danger mb-0">
                  <div class="d-flex align-items-center mb-1">
                    <i class="bi bi-x-circle-fill me-2"></i>
                    <strong>{{ resultado.erros_segmentos|length }} erro(s) em segmentos</strong>
                  </div>
                  <ul class="list-unstyled mb-0">
                    {% for e in resultado.erros_segmentos %}
                    <li class="mb-1 d-flex">
                      <span class="me-2 text-danger">
                        <i class="bi bi-dash-circle"></i>
                      </span>
                      <span class="small">
                        {{ e }}
                      </span>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% else %}
                {% if total_avisos_seg == 0 %}

                <!-- ============================= SEGMENTO R ============================= -->
                {% if resultado.avisos_segmentos_r and resultado.avisos_segmentos_r|length > 0 %}
                <div class="alert alert-warning mb-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-exclamation-circle text-warning me-2"></i>
                    <strong>Avisos — Segmento R ({{ resultado.avisos_segmentos_r|length }})</strong>
                  </div>

                  <ul class="list-unstyled mb-0">
                    {% for a in resultado.avisos_segmentos_r %}
                    <li class="mb-2 d-flex">
                      <span class="me-2 text-warning">
                        <i class="bi bi-dot"></i>
                      </span>
                      <span class="small">{{ a }}</span>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
                {% endif %}

                <div class="alert alert-success mb-0">
                  Nenhum erro encontrado nos segmentos configurados para este banco.
                </div>
                {% endif %}
                {% endif %}
              </div>
            </div>
          </div>
          {% endif %}
        </div>
        {% elif resultado.layout == 400 %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Header do arquivo</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseHeader400" aria-expanded="true" aria-controls="collapseHeader400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseHeader400" class="collapse show">
            <div class="card-body">
              {% set header = resultado.cnab400_header_info %}
              {% if header %}
              <ul class="list-unstyled small mb-3">
                <li><strong>Nome do beneficiário:</strong> {{ header.nome_beneficiario or "-" }}</li>
                <li><strong>Agência:</strong> {{ header.agencia }}{% if header.agencia_dv %}-{{ header.agencia_dv }}{% endif %}</li>
                <li><strong>Conta:</strong> {{ header.conta }}{% if header.conta_dv %}-{{ header.conta_dv }}{% endif %}</li>
                <li><strong>Convênio líder:</strong> {{ header.numero_convenio_lider or "-" }}</li>
                <li><strong>Seq. remessa:</strong> {{ header.sequencial_remessa or "-" }}</li>
                <li><strong>Data de gravação:</strong>
                  {% if header.data_gravacao %}{{ header.data_gravacao.strftime("%d/%m/%Y") }}{% else %}-{% endif %}
                </li>
              </ul>
              {% endif %}
              {% if resultado.cnab400_erros_header and resultado.cnab400_erros_header|length > 0 %}
              <div class="alert alert-danger mb-0">
                <ul class="mb-0">
                  {% for e in resultado.cnab400_erros_header %}
                  <li>{{ e }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% else %}
              <div class="alert alert-success mb-0">
                Nenhum problema crítico identificado no header.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Registros tipo 7 (detalhe)</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseDetalhes400" aria-expanded="true" aria-controls="collapseDetalhes400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseDetalhes400" class="collapse show">
            <div class="card-body">
              {% if resultado.cnab400_erros_registros and resultado.cnab400_erros_registros|length > 0 %}
              <div class="alert alert-danger mb-0">
                <p class="mb-1">Problemas encontrados:</p>
                <ul class="mb-0">
                  {% for e in resultado.cnab400_erros_registros %}
                  <li>{{ e }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% else %}
              <div class="alert alert-success mb-0">
                Nenhum erro crítico foi encontrado nos registros de detalhe.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Trailer e sequência</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseTrailer400" aria-expanded="true" aria-controls="collapseTrailer400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseTrailer400" class="collapse show">
            <div class="card-body">
              {% if resultado.cnab400_erros_trailer and resultado.cnab400_erros_trailer|length > 0 %}
              <div class="alert alert-danger mb-0">
                <ul class="mb-0">
                  {% for e in resultado.cnab400_erros_trailer %}
                  <li>{{ e }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% else %}
              <div class="alert alert-success mb-0">
                Trailer e sequência geral estão consistentes.
              </div>
              {% endif %}
            </div>
          </div>
        </div>

        {% if resultado.cnab400_avisos and resultado.cnab400_avisos|length > 0 %}
        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Avisos gerais</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseAvisos400" aria-expanded="true" aria-controls="collapseAvisos400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseAvisos400" class="collapse show">
            <div class="card-body">
              <div class="alert alert-warning mb-0">
                <ul class="mb-0">
                  {% for aviso in resultado.cnab400_avisos %}
                  <li>{{ aviso }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>Resumo da remessa CNAB 400</strong>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseResumo400" aria-expanded="true" aria-controls="collapseResumo400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseResumo400" class="collapse show">
            <div class="card-body">
              {% set resumo = resultado.resumo_cnab400 %}
              {% if resumo %}
              <ul class="list-unstyled small mb-3">
                <li><strong>Títulos:</strong> {{ resumo.qtd_titulos }}</li>
                <li><strong>Valor total:</strong> R$ {{ "%.2f"|format(resumo.valor_total_reais) }}</li>
                <li><strong>Vencimento mais antigo:</strong>
                  {% if resumo.vencimento_min %}{{ resumo.vencimento_min.strftime("%d/%m/%Y") }}{% else %}-{% endif %}
                </li>
                <li><strong>Vencimento mais recente:</strong>
                  {% if resumo.vencimento_max %}{{ resumo.vencimento_max.strftime("%d/%m/%Y") }}{% else %}-{% endif %}
                </li>
                <li><strong>Registros opcionais (tipo 5):</strong> {{ resumo.qtd_registros_tipo5 }}</li>
              </ul>
              {% if resumo.comandos and resumo.comandos|length > 0 %}
              <div class="fw-semibold small text-uppercase text-muted mb-1">Distribuição por comando</div>
              <div class="d-flex flex-wrap gap-1 mb-2">
                {% for cmd in resumo.comandos %}
                <span class="badge bg-light text-dark">Cmd {{ cmd.codigo }}: {{ cmd.quantidade }}</span>
                {% endfor %}
              </div>
              {% endif %}
              {% if resumo.carteiras and resumo.carteiras|length > 0 %}
              <div class="fw-semibold small text-uppercase text-muted mb-1">Carteiras informadas</div>
              <div class="d-flex flex-wrap gap-1">
                {% for cart in resumo.carteiras %}
                <span class="badge bg-light text-dark">Carteira {{ cart.codigo }}: {{ cart.quantidade }}</span>
                {% endfor %}
              </div>
              {% endif %}
              {% else %}
              <p class="text-muted mb-0">Resumo não disponível para este arquivo.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              <strong>Títulos da remessa</strong>
              {% if resultado.titulos and resultado.titulos|length > 0 %}
              <span class="badge bg-secondary ms-2">
                {{ resultado.titulos|length }} título(s)
              </span>
              {% endif %}
            </div>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#collapseTitulos400" aria-expanded="true" aria-controls="collapseTitulos400">
              <span class="label-btn">Recolher</span>
              <i class="bi bi-chevron-up"></i>
            </button>
          </div>
          <div id="collapseTitulos400" class="collapse show">
            <div class="card-body card-body-scroll">
              {% if resultado.titulos and resultado.titulos|length > 0 %}
              <div class="table-responsive">
                <div class="table-fixed-header">
                  <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">#</th>
                        <th scope="col">Seq.</th>
                        <th scope="col">Nosso número</th>
                        <th scope="col">Seu número</th>
                        <th scope="col">Pagador</th>
                        <th scope="col">Documento</th>
                        <th scope="col">Vencimento</th>
                        <th scope="col" class="text-end">Valor (R$)</th>
                        <th scope="col">Comando</th>
                        <th scope="col">Carteira</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for t in resultado.titulos %}
                      {% set has_extra = (
                        t.endereco_pagador or t.bairro_pagador or t.cidade_pagador or t.uf_pagador or
                        t.desconto_valor_centavos or t.multa_codigo or
                        (t.emails_pagador and t.emails_pagador|length > 0) or
                        t.observacoes or t.opcional_desc2_valor_reais or t.opcional_desc3_valor_reais or
                        t.valor_abatimento_centavos or t.valor_iof_centavos or t.juros_centavos or
                        t.agente_negativador
                      ) %}
                      <tr {% if has_extra %} data-bs-toggle="collapse" data-bs-target="#detTitulo400{{ loop.index }}"
                        class="cursor-pointer" {% endif %}>
                        <td>{{ loop.index }}</td>
                        <td>{{ t.sequencial_registro }}</td>
                        <td>{{ t.nosso_numero or '-' }}</td>
                        <td>{{ t.seu_numero_15 or t.seu_numero or '-' }}</td>
                        <td>{{ t.nome_pagador or '-' }}</td>
                        <td>{{ t.documento_pagador or '-' }}</td>
                        <td>
                          {% if t.data_vencimento_str %}
                          {{ t.data_vencimento_str }}
                          {% else %}
                          -
                          {% endif %}
                        </td>
                        <td class="text-end">
                          {{ "%.2f"|format(t.valor_reais) }}
                        </td>
                        <td>{{ t.comando or '-' }}</td>
                        <td>{{ t.carteira or '-' }}</td>
                      </tr>
                      {% if has_extra %}
                      <tr id="detTitulo400{{ loop.index }}" class="collapse bg-light">
                        <td colspan="10">
                          <div class="titulo-detalhes">
                            <div class="mb-2">
                              <strong>Pagador:</strong> {{ t.nome_pagador or '-' }} — Doc: {{ t.documento_pagador or '-' }}
                              <br>
                              <small>Tipo doc: {{ t.tipo_inscricao_pagador or '-' }}
                                | Indicador parcial: {{ t.indicador_recebimento_parcial or '-' }}
                                | Dias protesto: {{ t.dias_protesto or '-' }}</small>
                            </div>
                            {% if t.endereco_pagador or t.cidade_pagador or t.uf_pagador %}
                            <div class="mb-2">
                              <strong>Endereço:</strong>
                              {{ t.endereco_pagador or '-' }}
                              {% if t.bairro_pagador %} — {{ t.bairro_pagador }}{% endif %}
                              <br>
                              <small>{{ t.cidade_pagador or '' }}{% if t.uf_pagador %} - {{ t.uf_pagador }}{% endif %}
                                {% if t.cep_pagador %}| CEP {{ t.cep_pagador }}{% endif %}</small>
                            </div>
                            {% endif %}
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-2">
                                  <strong>Descontos:</strong>
                                  {% if t.desconto_valor_centavos %}
                                  R$ {{ "%.2f"|format(t.desconto_valor_reais) }}
                                  {% else %}
                                  (não informado)
                                  {% endif %}
                                  {% if t.desconto_data_str %} — até {{ t.desconto_data_str }}{% endif %}
                                </div>
                                {% if t.opcional_desc2_valor_reais or t.opcional_desc2_data_str %}
                                <div class="mb-2">
                                  <strong>2º Desconto:</strong>
                                  {% if t.opcional_desc2_valor_reais %}
                                  R$ {{ "%.2f"|format(t.opcional_desc2_valor_reais) }}
                                  {% else %}-{% endif %}
                                  {% if t.opcional_desc2_data_str %} — {{ t.opcional_desc2_data_str }}{% endif %}
                                </div>
                                {% endif %}
                                {% if t.opcional_desc3_valor_reais or t.opcional_desc3_data_str %}
                                <div class="mb-2">
                                  <strong>3º Desconto:</strong>
                                  {% if t.opcional_desc3_valor_reais %}
                                  R$ {{ "%.2f"|format(t.opcional_desc3_valor_reais) }}
                                  {% else %}-{% endif %}
                                  {% if t.opcional_desc3_data_str %} — {{ t.opcional_desc3_data_str }}{% endif %}
                                </div>
                                {% endif %}
                                {% if t.multa_codigo %}
                                <div class="mb-2">
                                  <strong>Multa:</strong> código {{ t.multa_codigo }},
                                  {% if t.multa_valor_reais %}
                                  valor R$ {{ "%.2f"|format(t.multa_valor_reais) }}
                                  {% else %}
                                  valor não informado
                                  {% endif %}
                                  {% if t.multa_data_str %} — início {{ t.multa_data_str }}{% endif %}
                                </div>
                                {% endif %}
                                <div class="mb-2">
                                  <strong>Juros de mora:</strong> R$ {{ "%.2f"|format(t.juros_reais) }}
                                </div>
                                <div class="mb-2">
                                  <strong>Abatimento:</strong> R$ {{ "%.2f"|format(t.valor_abatimento_reais) }}
                                </div>
                                <div class="mb-2">
                                  <strong>IOF:</strong> R$ {{ "%.2f"|format(t.valor_iof_reais) }}
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-2">
                                  <strong>Carteira/variação:</strong> {{ t.carteira or '-' }} / {{ t.variacao_carteira or '-' }}
                                </div>
                                <div class="mb-2">
                                  <strong>Tipo de cobrança:</strong> {{ t.tipo_cobranca or '-' }}
                                </div>
                                <div class="mb-2">
                                  <strong>Instruções:</strong> {{ t.instrucao1 or '-' }} / {{ t.instrucao2 or '-' }}
                                </div>
                                <div class="mb-2">
                                  <strong>Seu número:</strong> {{ t.seu_numero_15 or t.seu_numero or '-' }}
                                </div>
                                <div class="mb-2">
                                  <strong>Número banco / agência cobradora:</strong>
                                  {{ t.numero_banco or '-' }} / {{ t.agencia_cobradora or '-' }}
                                </div>
                                {% if t.agente_negativador %}
                                <div class="mb-2">
                                  <strong>Agente negativador:</strong> {{ t.agente_negativador }}
                                </div>
                                {% endif %}
                              </div>
                            </div>
                            {% if t.emails_pagador and t.emails_pagador|length > 0 %}
                            <div class="mb-2">
                              <strong>E-mails do pagador:</strong>
                              <div class="small">
                                {{ t.emails_pagador|join(', ') }}
                              </div>
                            </div>
                            {% endif %}
                            {% if t.observacoes %}
                            <div class="mb-0">
                              <strong>Observações:</strong> {{ t.observacoes }}
                            </div>
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                      {% endif %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% else %}
              <p class="text-muted mb-0">
                Nenhum registro tipo 7 foi identificado para listar.
              </p>
              {% endif %}
            </div>
          </div>
        </div>
        {% else %}
        <div class="alert alert-info">
          Ainda não há painel específico para o layout CNAB {{ resultado.layout }}.
        </div>
        {% endif %}

      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script para alternar ícone e texto dos botões de recolher/expandir -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (btn) {
        const icon = btn.querySelector('i');
        const label = btn.querySelector('.label-btn');
        const targetSelector = btn.getAttribute('data-bs-target');
        const target = document.querySelector(targetSelector);

        if (!target || !icon || !label) return;

        target.addEventListener('shown.bs.collapse', function () {
          icon.classList.remove('bi-chevron-down');
          icon.classList.add('bi-chevron-up');
          label.textContent = 'Recolher';
        });

        target.addEventListener('hidden.bs.collapse', function () {
          icon.classList.remove('bi-chevron-up');
          icon.classList.add('bi-chevron-down');
          label.textContent = 'Expandir';
        });
      });
    });
  </script>
</body>

</html>
